// ==============================================
// Avalanche Agent Scanner - Prisma Schema
// ERC-8004 Standard Implementation
// ==============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================
// AGENT (Identity Registry - ERC-721)
// ==============================================
model Agent {
  id              Int      @id @default(autoincrement())
  agentId         BigInt   @unique // On-chain tokenId
  chainId         Int
  registryAddress String   
  ownerAddress    String   
  
  // AgentURI metadata (hydrated off-chain)
  agentURI        String?  
  name            String?
  description     String?  
  image           String?  
  
  // Status fields
  active          Boolean  @default(false)
  x402Support     Boolean  @default(false)
  isA2AVerified   Boolean  @default(false)
  complianceScore Int      @default(0)
  supportedTrust  String?
  
  // Integrity
  agentHash       String?   // keccak256 of canonical JSON
  
  // On-chain metadata
  agentWallet     String?  
  
  // Timestamps
  registeredAt    DateTime @default(now())
  lastIndexedAt   DateTime @default(now())
  lastHydratedAt  DateTime?
  
  // Indexing info
  registeredBlock BigInt
  registeredTx    String   
  
  // Relations
  endpoints       Endpoint[]
  feedback        Feedback[]
  validationsAsAgent     Validation[] @relation("AgentValidations")
  scans           EndpointScan[]
  scanJobs        ScanJob[]
  metadataEntries AgentMetadata[]
  metadataTasks   MetadataTask[]
  
  @@index([chainId, registryAddress])
  @@index([ownerAddress])
  @@index([active])
  @@index([x402Support])
}

// ==============================================
// AGENT ON-CHAIN METADATA
// ==============================================
model AgentMetadata {
  id          Int    @id @default(autoincrement())
  agentId     BigInt
  metadataKey String
  metadataValue String
  
  agent       Agent  @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([agentId, metadataKey])
  @@index([metadataKey])
}

// ==============================================
// ENDPOINTS (from AgentURI services/endpoints)
// ==============================================
model Endpoint {
  id          Int      @id @default(autoincrement())
  agentId     BigInt
  
  // Endpoint definition
  name        String   // "MCP", "A2A", "OASF", "web", "ENS", etc.
  endpoint    String    // URL or identifier
  version     String?
  
  // Protocol-specific fields (JSON)
  capabilities Json?   // For MCP
  skills       Json?   // For OASF
  domains      Json?   // For OASF
  
  // Trust status (from Sentinel scans)
  isVerified  Boolean  @default(false)
  tlsValid    Boolean?
  dnsValid    Boolean?
  a2aVerified Boolean  @default(false)
  lastChecked DateTime?
  
  agent       Agent    @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  scans       EndpointScan[]
  scanJobs    ScanJob[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([agentId])
  @@index([name])
}

// ==============================================
// ENDPOINT SCANS (Sentinel Trust Layer)
// ==============================================
model EndpointScan {
  id          Int      @id @default(autoincrement())
  agentId     BigInt
  endpointId  Int?
  
  // Scan target
  url         String   
  
  // TLS checks
  tlsValid    Boolean  @default(false)
  tlsVersion  String?
  tlsExpiry   DateTime?
  tlsIssuer   String?
  
  // DNS checks
  dnsValid    Boolean  @default(false)
  dnsRecords  Json?
  
  // HTTP checks
  httpStatus  Int?
  httpLatency Int?     // ms
  httpHeaders Json?
  
  // Security headers
  hasHSTS     Boolean  @default(false)
  hasCSP      Boolean  @default(false)
  hasCORS     Boolean  @default(false)
  
  // Overall score
  trustScore  Int      @default(0) // 0-100
  
  // Error tracking
  error       String?  
  
  scannedAt   DateTime @default(now())
  
  agent       Agent    @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  endpoint    Endpoint? @relation(fields: [endpointId], references: [id], onDelete: SetNull)
  
  @@index([agentId])
  @@index([trustScore])
  @@index([scannedAt])
}

// ==============================================
// FEEDBACK (Reputation Registry)
// ==============================================
model Feedback {
  id             Int      @id @default(autoincrement())
  agentId        BigInt
  
  // On-chain data
  clientAddress  String   
  feedbackIndex  BigInt
  score          Int      // 0-100
  tag1           String?
  tag2           String?
  targetEndpoint String?  
  feedbackURI    String?  
  feedbackHash   String?  
  
  // Off-chain hydration
  feedbackContent Json?
  
  // Status
  isRevoked      Boolean  @default(false)
  revokedAt      DateTime?
  
  // Responses
  responses      FeedbackResponse[]
  
  // Indexing info
  createdBlock   BigInt
  createdTx      String   
  createdAt      DateTime @default(now())
  
  agent          Agent    @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  
  @@unique([agentId, clientAddress, feedbackIndex])
  @@index([agentId])
  @@index([clientAddress])
  @@index([score])
  @@index([tag1])
}

// ==============================================
// FEEDBACK RESPONSES
// ==============================================
model FeedbackResponse {
  id            Int      @id @default(autoincrement())
  feedbackId    Int
  
  responderAddress String 
  responseURI   String?  
  responseHash  String?  
  
  // Off-chain hydration
  responseContent Json?
  
  // Indexing info
  createdBlock  BigInt
  createdTx     String   
  createdAt     DateTime @default(now())
  
  feedback      Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  
  @@unique([feedbackId, responderAddress, createdTx])
  @@index([feedbackId])
  @@index([responderAddress])
}

// ==============================================
// VALIDATIONS (Validation Registry)
// ==============================================
model Validation {
  id               Int      @id @default(autoincrement())
  agentId          BigInt
  
  // Request
  validatorAddress String   
  requestURI       String?  
  requestHash      String    @unique
  
  // Off-chain hydration
  requestContent   Json?
  
  // Latest response
  response         Int?     // 0-100
  responseURI      String?  
  responseHash     String?  
  responseTag      String?
  responseContent  Json?
  
  // Status
  status           ValidationStatus @default(PENDING)
  lastUpdate       DateTime?
  
  // Indexing info
  requestedBlock   BigInt
  requestedTx      String   
  respondedBlock   BigInt?
  respondedTx      String?  
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  agent            Agent    @relation("AgentValidations", fields: [agentId], references: [agentId], onDelete: Cascade)
  
  @@index([agentId])
  @@index([validatorAddress])
  @@index([status])
}

enum ValidationStatus {
  PENDING
  PASSED
  FAILED
  PARTIAL
}

// ==============================================
// INDEXER STATE
// ==============================================
model IndexerCursor {
  id           Int      @id @default(autoincrement())
  chainId      Int
  registry     String   // "identity" | "reputation" | "validation"
  lastBlock    BigInt
  lastTx       String?  
  
  updatedAt    DateTime @updatedAt
  
  @@unique([chainId, registry])
}

// ==============================================
// SYSTEM STATS
// ==============================================
model SystemStats {
  id              Int      @id @default(autoincrement())
  chainId         Int      @unique
  
  totalAgents     Int      @default(0)
  activeAgents    Int      @default(0)
  totalFeedback   Int      @default(0)
  totalValidations Int     @default(0)
  x402Agents      Int      @default(0)
  
  updatedAt       DateTime @updatedAt
}
// ==============================================
// BACKGROUND TASKS
// ==============================================
model MetadataTask {
  id            Int           @id @default(autoincrement())
  agentId       BigInt
  uri           String        
  type          TaskType      @default(AGENT_METADATA)
  status        TaskStatus    @default(PENDING)
  
  // Retry logic
  attempts      Int           @default(0)
  lastError     String?       
  nextRunAt     DateTime      @default(now())
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  agent         Agent         @relation(fields: [agentId], references: [agentId], onDelete: Cascade)

  @@unique([agentId, uri, type])
  @@index([status, nextRunAt])
  @@index([agentId])
}

enum TaskType {
  AGENT_METADATA
  FEEDBACK_METADATA
  VALIDATION_METADATA
}

enum TaskStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ==============================================
// SCAN JOBS (Decoupled Sentinel Queue)
// ==============================================
model ScanJob {
  id            Int           @id @default(autoincrement())
  agentId       BigInt
  endpointId    Int?
  url           String        
  status        TaskStatus    @default(PENDING)
  
  // Handshake details
  challenge     String?       // Nonce sent to agent
  signature     String?       // Response from agent
  
  // Retry logic
  attempts      Int           @default(0)
  lastError     String?       
  nextRunAt     DateTime      @default(now())
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  agent         Agent         @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  endpoint      Endpoint?     @relation(fields: [endpointId], references: [id], onDelete: SetNull)

  @@index([status, nextRunAt])
  @@index([agentId])
}
